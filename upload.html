<html ng-app="imageApi" >
	
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
		<style>
			*{
	margin:0;
	padding:0;
}

body{
	font:15px/1.3 'Open Sans', sans-serif;
	color: #5e5b64;
	text-align:center;
}

a, a:visited {
	outline:none;
	color:#389dc1;
}

a:hover{
	text-decoration:none;
}

section, footer, header, aside, nav{
	display: block;
}

/*-------------------------
	The search input
--------------------------*/

.bar{
	background-color:#5c9bb7;

	background-image:-webkit-linear-gradient(top, #5c9bb7, #5392ad);
	background-image:-moz-linear-gradient(top, #5c9bb7, #5392ad);
	background-image:linear-gradient(top, #5c9bb7, #5392ad);

	box-shadow: 0 1px 1px #ccc;
	border-radius: 2px;
	padding: 14px;
	margin: 45px auto 20px;
	position:relative;
}

.bar input{
	background:#fff no-repeat 13px 13px;
	background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkU5NEY0RTlFMTA4NzExRTM5RTEzQkFBQzMyRjkyQzVBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkU5NEY0RTlGMTA4NzExRTM5RTEzQkFBQzMyRjkyQzVBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RTk0RjRFOUMxMDg3MTFFMzlFMTNCQUFDMzJGOTJDNUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RTk0RjRFOUQxMDg3MTFFMzlFMTNCQUFDMzJGOTJDNUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4DjA/RAAABK0lEQVR42pTSQUdEURjG8dOY0TqmPkGmRcqYD9CmzZAWJRHVRIa0iFYtM6uofYaiEW2SRJtEi9YxIklp07ZkWswu0v/wnByve7vm5ee8M+85zz1jbt9Os+WiGkYdYxjCOx5wgFeXUHmtBSzpcCGa+5BJTCjEP+0nKWAT8xqe4ArPGEEVC1hHEbs2oBwdXkM7mj/JLZrad437sCGHOfUtcziutuYu2v8XUFF/4f6vMK/YgAH1HxkBYV60AR31gxkBYd6xAeF3VzMCwvzOBpypX8V4yuFRzX2d2gD/l5yjH4fYQEnzkj4fae5rJulF2sMXVrAsaTWttRFu4Osb+1jEDT71/ZveyhouTch2fINQL9hKefKjuYFfuznXWzXMTabyrvfyIV3M4vhXgAEAUMs7K0J9UJAAAAAASUVORK5CYII=);

	border: none;
	width: 100%;
	line-height: 19px;
	padding: 11px 0;

	border-radius: 2px;
	box-shadow: 0 2px 8px #c4c4c4 inset;
	text-align: left;
	font-size: 14px;
	font-family: inherit;
	color: #738289;
	font-weight: bold;
	outline: none;
	text-indent: 40px;
}

ul{
	list-style: none;
	margin: 20px auto;
	text-align: left;
}

ul li{
	border-bottom: 1px solid #ddd;
	padding: 10px;
	overflow: hidden;
}

ul li img{
	width:60px;
	height:60px;
	float:left;
	border:none;
}

ul li p{
	margin-left: 75px;
	font-weight: bold;
	padding-top: 12px;
	color:#6e7a7f;
}

.actions{
	
	float: right;
}

		</style>
	</head>
	
	<body ng-controller="mainCtrl" >
		<!-- upload new image -->
		<h1>Upload new image</h1>
		<input type='file' name='file' file-model="uploadFile" file-change="uploadNewFile()" />
	
		<div class="bar">
			<!-- Create a binding between the searchString model and the text field -->
			<input type="text" ng-model="imgFilter.name" placeholder="Enter your search terms" />
		</div>
		<!-- image list -->
		<ul>
			<li ng-repeat="i in imageList | filter:imgFilter" >
				<a href="#">
					<img ng-src="https://s3-us-west-2.amazonaws.com/shenkar-shlomi-imageapi/images/{{i._id}}?clearcash=" 
				/></a>
				<p>{{i.name}}</p>
				
				<div class="actions" >
					<!-- add meta -->
					<input type="button" ng-click="addMeta(i._id)" value="meta" />
					
					<input type="button" ng-click="del(i._id)" value="delete" />
					
					<input type='file' name='file' file-model="i.updateFile" file-change="updateExistingFile(i)" />
				</div>
			
			</li>
		</ul>
	
		<script>
			
			
			angular.module("imageApi", [])
			.directive('fileModel', ['$parse', function ($parse) {
	            return {
	               restrict: 'A',
	               link: function(scope, element, attrs) {
	                  var model = $parse(attrs.fileModel);
	                  var callback = $parse(attrs.fileChange);
	                  var modelSetter = model.assign;
	                  
	                  element.bind('change', function(){
	                     scope.$apply(function(){
	                        modelSetter(scope, element[0].files[0]);
	                        callback(scope);
	                     });
	                  });
	               }
	            };
	         }])
			.controller("mainCtrl", ['$scope', '$http', function($scope, $http){
				
				$scope.loadImages = function(){
					
					$http.get("./get").then(function(res){
						
						$scope.imageList = res.data;
						
					}, function(){
						
					});
				}
				
				$scope.getTime = function(){
					
					return new Date();
				}
				
				$scope.loadImages();
				
				
				$scope.addMeta = function(id){
					
					var creator = prompt("Creator name?", null);
					var title = prompt("Image title?", null);
					
					$http.put("./meta/"+id,{"creator": "'+creator+'", "title":"'+title+'"})
					    .then(function(data){
					    	alert('ok');
					    }, function(){
					    	
					    });
					
				}
				$scope.del = function(id){
					
					$http.delete("./delete/"+id,{})
					    .then(function(data){
					    	$scope.loadImages();
					    }, function(){
					    	
					    });
					
				}
				
				$scope.uploadNewFile = function() {
				    //$files: an array of files selected, each file has name, size, and type.
				    //for (var i = 0; i < $files.length; i++) {
				      //var $file = $files[i];
				      var fd = new FormData();
				        fd.append('file', $scope.uploadFile);
				        $http.post('./upload', fd, {
				            transformRequest: angular.identity,
				            headers: {'Content-Type': undefined}
				        }).then(function(){
				        	$scope.loadImages();
				        },function(){
				        	
				        });
				        
				   // }
				  }
				  
				$scope.updateExistingFile = function(img) {
				    //$files: an array of files selected, each file has name, size, and type.
				    //for (var i = 0; i < $files.length; i++) {
				      //var $file = $files[i];
				      var fd = new FormData();
				        fd.append('file', img.updateFile);
				        $http.post('./update/'+img._id, fd, {
				            transformRequest: angular.identity,
				            headers: {'Content-Type': undefined}
				        }).then(function(){
				        	$scope.loadImages();
				        },function(){
				        	
				        });
				        
				   // }
				  }
				
			}]);
			
		</script>
	
	</body>
</html>